L.AGS=L.Class.extend({}),L.AGS.Layer=L.Class.extend({includes:L.Mixin.Events}),L.AGS.Layer.Dynamic=L.ImageOverlay.extend({defaultParams:{format:"png8",transparent:!0,f:"image",bboxSR:102100,imageSR:102100},initialize:function(a,b,c){this._url=a,this._bounds=L.latLngBounds(b),this._layerParams=L.Util.extend({},this.defaultParams);for(var d in c)this.options.hasOwnProperty(d)||(this._layerParams[d]=c[d]);delete this._layerParams.token,this._parseLayers(),this._parseLayerDefs(),L.Util.setOptions(this,c)},onAdd:function(a){this._map=a,this._image||this._initImage(),a._panes.overlayPane.appendChild(this._image),a.on({viewreset:this._reset,moveend:this._update,zoomend:this._zoomUpdate},this),a.options.zoomAnimation&&L.Browser.any3d&&a.on("zoomanim",this._animateZoom,this),this._reset()},onRemove:function(a){a.getPanes().overlayPane.removeChild(this._image),a.off({viewreset:this._reset,moveend:this._update},this),a.options.zoomAnimation&&a.off("zoomanim",this._animateZoom,this)},_parseLayers:function(){if("undefined"==typeof this._layerParams.layers)return delete this._layerParams.layerOption,void 0;var a=this._layerParams.layerOption||null,b=this._layerParams.layers||null,c="show",d=["show","hide","include","exclude"];if(delete this._layerParams.layerOption,a)-1!=d.indexOf(a)&&(c=a),this._layerParams.layers=c+":"+b;else if(b instanceof Array)this._layerParams.layers=c+":"+b.join(",");else if("string"==typeof b){var e=b.match(":");e&&(b=b.split(e[0]),Number(b[1].split(",")[0])&&(-1!=d.indexOf(b[0])&&(c=b[0]),b=b[1])),this._layerParams.layers=c+":"+b}},_parseLayerDefs:function(){if("undefined"!=typeof this._layerParams.layerDefs){var a=this._layerParams.layerDefs,b=[];if(a instanceof Array)for(var c=a.length,d=0;c>d;d++)a[d]&&b.push(d+":"+a[d]);else{if("object"!=typeof a)return delete this._layerParams.layerDefs,void 0;for(var e in a)b.push(e+":"+a[e])}this._layerParams.layerDefs=b.join(";")}},_initImage:function(){this._image=L.DomUtil.create("img","leaflet-image-layer"),this._map.options.zoomAnimation&&L.Browser.any3d?L.DomUtil.addClass(this._image,"leaflet-zoom-animated"):L.DomUtil.addClass(this._image,"leaflet-zoom-hide"),this._updateOpacity(),L.Util.extend(this._image,{galleryimg:"no",onselectstart:L.Util.falseFn,onmousemove:L.Util.falseFn,onload:L.Util.bind(this._onImageLoad,this),src:this._getImageUrl()})},_getImageUrl:function(){var a=this._map.getBounds(),b=this._map.getSize(),c=this._map.options.crs.project(a._northEast),d=this._map.options.crs.project(a._southWest);this._layerParams.bbox=[d.x,d.y,c.x,c.y].join(","),this._layerParams.size=b.x+","+b.y;var e=this._url+"/export"+L.Util.getParamString(this._layerParams);return"undefined"!=typeof this.options.token&&(e=e+"&token="+this.options.token),e},_update:function(){if(!this._map._panTransition||!this._map._panTransition._inProgress){var a=this._map.getZoom();a>this.options.maxZoom||a<this.options.minZoom||(this._newImage=L.DomUtil.create("img","leaflet-image-layer"),this._map.options.zoomAnimation&&L.Browser.any3d?L.DomUtil.addClass(this._newImage,"leaflet-zoom-animated"):L.DomUtil.addClass(this._newImage,"leaflet-zoom-hide"),this._updateOpacity(),L.Util.extend(this._newImage,{galleryimg:"no",onselectstart:L.Util.falseFn,onmousemove:L.Util.falseFn,onload:L.Util.bind(this._onNewImageLoad,this),src:this._getImageUrl()}))}},_zoomUpdate:function(){},_onNewImageLoad:function(){var a=this._map.getBounds(),b=L.latLng(a._northEast.lat,a._southWest.lng),c=L.latLng(a._southWest.lat,a._northEast.lng),d=this._map.latLngToLayerPoint(b),e=this._map.latLngToLayerPoint(c)._subtract(d);L.DomUtil.setPosition(this._newImage,d),this._newImage.style.width=e.x+"px",this._newImage.style.height=e.y+"px",this._map._panes.overlayPane.appendChild(this._newImage),this._map._panes.overlayPane.removeChild(this._image),this._image=this._newImage,this._newImage=null},_onImageLoad:function(){this.fire("load")},_reset:function(){}}),L.agsDynamicLayer=function(a,b,c){return new L.AGS.Layer.Dynamic(a,b,c)},L.AGS.Layer.Tiled=L.TileLayer.extend({getTileUrl:function(a){this._adjustTilePoint(a);var b=this._url+"/tile/{z}/{y}/{x}",c=this._getZoomForUrl();return b=b.replace("{s}","").replace("{z}",c).replace("{x}",a.x).replace("{y}",a.y),"token"in this.options?b+"?token="+this.options.token:b}}),L.agsTileLayer=function(a,b){return new L.AGS.Layer.Tiled(a,b)},L.AGS.Layer.Tiled.Dynamic=L.AGS.Layer.Tiled.extend({defaultParams:{format:"png8",transparent:!0,nocache:!1,f:"image",bboxSR:102100},initialize:function(a,b){this._url=a,this._layerParams=L.Util.extend({},this.defaultParams),this._layerParams.width=this._layerParams.height=this.options.tileSize;for(var c in b)this.options.hasOwnProperty(c)||(this._layerParams[c]=b[c]);delete this._layerParams.token,this.parseLayers(),this.parseLayerDefs(),L.Util.setOptions(this,b)},onAdd:function(){L.TileLayer.prototype.onAdd.call(this,map)},parseLayers:function(){if("undefined"==typeof this._layerParams.layers)return delete this._layerParams.layerOption,void 0;var a=this._layerParams.layerOption||null,b=this._layerParams.layers||null,c="show",d=["show","hide","include","exclude"];if(delete this._layerParams.layerOption,a)-1!=d.indexOf(a)&&(c=a),this._layerParams.layers=c+":"+b;else if(b instanceof Array)this._layerParams.layers=c+":"+b.join(",");else if("string"==typeof b){var e=b.match(":");e&&(b=b.split(e[0]),Number(b[1].split(",")[0])&&(-1!=d.indexOf(b[0])&&(c=b[0]),b=b[1])),this._layerParams.layers=c+":"+b}},parseLayerDefs:function(){if("undefined"!=typeof this._layerParams.layerDefs){var a=this._layerParams.layerDefs,b=[];if(a instanceof Array)for(var c=a.length,d=0;c>d;d++)a[d]&&b.push(d+":"+a[d]);else{if("object"!=typeof a)return delete this._layerParams.layerDefs,void 0;for(var e in a)b.push(e+":"+a[e])}this._layerParams.layerDefs=b.join(";")}},getTileUrl:function(a){var b=this.options.tileSize,c=a.multiplyBy(b),d=c.add(new L.Point(b,b)),e=this._map.unproject(c,this._zoom,!0),f=this._map.unproject(d,this._zoom,!0),g=this._map.options.crs.project(e),h=this._map.options.crs.project(f),i=[g.x,h.y,h.x,g.y].join(",");this._layerParams.bbox=i,this._layerParams.size=this.options.tileSize+","+this.options.tileSize,this._layerParams.nocache?this._layerParams.nocache=1e16*Math.random():delete this._layerParams.nocache;var j=this._url+"/export"+L.Util.getParamString(this._layerParams);return"undefined"!=typeof this.options.type&&(j=j+"&type="+this.options.type),"undefined"!=typeof this.options.token&&(j=j+"&token="+this.options.token),j}}),L.AGS.Security=L.AGS.extend({token:{},options:{},initialize:function(a,b,c){L.Util.setOptions(this,b),this._url=a,this._callback=c,"undefined"!=typeof this.options.username&&"undefined"!=typeof this.options.password?this.fetchToken(this.options.username,this.options.password):this.getUserInfo()},getUserInfo:function(){var a=this,b=document.createElement("div");b.className+="esri_user_info",b.id="esri_user_info",document.body.appendChild(b);var c=document.createElement("form");b.appendChild(c);var d=document.createElement("input");d.id="esri_login",d.type="text","undefined"!=typeof this.options.username&&(d.value=this.options.username),c.appendChild(d);var e=document.createElement("input");e.id="esri_pass",e.type="password",c.appendChild(e);var f=document.createElement("input");f.id="submit",f.type="submit",c.appendChild(f);var g=window.innerWidth||document.documentElement.clientWidth,h=window.innerHeight||document.documentElement.clientHeight;b.style.left=g/2-b.offsetWidth/2+"px",b.style.top=h/2-b.offsetHeight/2+"px",b.style.visibility="visible";var i;i="getComputedStyle"in window?window.getComputedStyle(b,null).backgroundColor:b.currentStyle.backgroundColor,("transparent"==i||"rgba(0, 0, 0, 0)"==i)&&(b.style.background="#aaaaaa"),"addEventListener"in c?c.addEventListener("submit",function(c){c.preventDefault();var d=document.getElementById("esri_login").value,e=document.getElementById("esri_pass").value;b.style.display="none",document.body.removeChild(b),a.fetchToken(d,e)},!1):c.attachEvent("onSubmit",function(c){c.preventDefault();var d=document.getElementById("esri_login").value,e=document.getElementById("esri_pass").value;b.style.display="none",document.body.removeChild(b),a.fetchToken(d,e)})},fetchToken:function(a,b){var c=this;this.options.username=a;var d=this._url+"/tokens",e="request=getToken&username="+a+"&password="+b+"&expiration=60",f=function(a,b){window.setToken=function(a){var b;"object"==typeof a&&a.token?b=a.token:"string"==typeof a&&(b=a);var d=new Date;c.token={value:b,expiration:+d.setMinutes(d.getMinutes()+59)},document.body.removeChild(document.getElementById("tokenJsonP")),delete window.setToken,"undefined"!=typeof c._callback&&c._callback()};var b="?"+b+"&f=pjson&callback=setToken",d=document.createElement("script");d.id="tokenJsonP",d.src=a+b,document.body.appendChild(d),setTimeout(function(){"undefined"==typeof c.token.value&&c.getUserInfo("failed login")},5e3)},g=function(a){var b;"object"==typeof a&&a.token?b=a.token:"string"==typeof a&&(b=a);var d=new Date;c.token={value:b,expiration:+d.setMinutes(d.getMinutes()+59)};var e=document.getElementById("tokenJsonP");e&&document.body.removeChild(e),"undefined"!=typeof c._callback&&c._callback()},h=new XMLHttpRequest;h.onreadystatechange=function(){4==h.readyState&&(400==h.status||0==h.status?(h.abort(),f(d,e)):200==h.status||304==h.status?g(h.responseText):403==h.status&&(h.abort(),c.getUserInfo("failed login")))};var i;if("FormData"in window){i=new FormData,e=e.split("&");for(var j=0;j<e.length;j++){var k=e[j].split("=");i.append(k[0],k[1])}}else i=e;if("XDomainRequest"in window){var l=new XDomainRequest;l.onerror=function(){l.abort(),f(d,e)},l.onload=function(){g(l.responseText)},l.open("POST",d,!0),l.send(i)}else h.open("POST",d,!0),"string"==typeof i&&h.setRequestHeader("Content-type","application/x-www-form-urlencoded"),h.send(i)}}),L.AGS.Tools=L.AGS.extend({}),L.AGS.Tools.Identify=L.AGS.Tools.extend({options:{f:"json",sr:"4326",layers:"top",returnGeometry:!0,tolerance:1},initialize:function(a,b,c){if(this._layer=a,"function"==typeof b){this._callback=b;var b={}}else this._callback=c;L.Util.setOptions(this,b),this.parseLayerDefs(),this.setMapExtent(),this.setImageDisplay()},parseGeometry:function(a){if("undefined"==typeof this.options.geometryType)if("string"==typeof a){var b=a.split(",").length;2==b?this.options.geometryType="esriGeometryPoint":4==b&&(this.options.geometryType="esriGeometryEnvelope")}else a instanceof Array?"number"==typeof a[1][0]?this.options.geometryType="esriGeometryPolyline":a[1][0]instanceof Array&&(this.options.geometryType="esriGeometryPolygon"):"object"==typeof a&&"undefined"!=typeof a.x&&(this.options.geometryType="esriGeometryPoint");this.options.geometry=a},parseLayerDefs:function(){var a=typeof this.options.layerDefs;if("undefined"!==a)if("object"!==a||this.options.layerDefs instanceof Array){if(this.options.layerDefs instanceof Array){for(var b={},c=0,d=this.options.layerDefs.length;d>c;c++)this.options.layerDefs[c]&&(b[c]=this.options.layerDefs[c]);this.options.layerDefs=JSON.stringify(b)}}else this.options.layerDefs=JSON.stringify(this.options.layerDefs)},setImageDisplay:function(){if("undefined"==typeof this.options.imageDisplay){var a=this._layer._map.getSize();this.options.imageDisplay=a.x+","+a.y+",96"}},setMapExtent:function(){if("undefined"==typeof this.options.mapExtent){var a=this._layer._map.getBounds();this.options.mapExtent=a._northEast.lng+","+a._southWest.lat+","+a._southWest.lng+","+a._northEast.lat}},execute:function(a){this.parseGeometry(a);var b=this,c=this._layer._url+"/identify",d=function(c){window.parseResponse=function(c){document.body.removeChild(document.getElementById("getJsonP")),b.findBestFeature(c,a),delete window.parseResponse},this.options.f="pjson";var d=document.createElement("script");d.id="getJsonP",d.src=c+L.Util.getParamString(this.options)+"&callback=parseResponse",document.body.appendChild(d)},e=function(a,c){var c=c.split(","),d=new L.LatLng(c[1],c[0]);if(b._layer._map,a=JSON.parse(a),a.results instanceof Array)if(1==a.results.length)"undefined"!=typeof b._callback&&b._callback(a.results[0]);else if(a.results.length>1){for(var e={type:null,dist:1e6,index:null},f=0,g=a.results.length;g>f;f++)if("undefined"!=typeof a.results[f]){var h=(a.results[f].attributes,a.results[f].geometry);if(h.hasOwnProperty("x")&&h.hasOwnProperty("y")){var i=new L.LatLng(h.y,h.x),j=i.distanceTo(d);j<e.dist&&(e.type="point",e.dist=j,e.index=f)}else if(h.hasOwnPropety("rings")){for(var k=[],l=h.rings,m=0,g=l.length;g>m;m++)k.push(new L.LatLng(l[0][m][1],l[0][m][0]));for(var n=!1,o=k.length-1,p=0,g=k.length;g>p;p++){var q=k[p].lat,r=k[p].lng,s=k[o].lat,t=k[o].lng,u=d.lat,v=d.lng;(v>r&&t>=v||v>t&&r>=v)&&u>q+(v-r)/(t-r)*(s-q)&&(n=!n),o=p}if(n){e.type="polygon",e.index=f;break}}}var w=a.results[e.index];"undefined"!=typeof b._callback&&b._callback(w)}},f=new XMLHttpRequest;if(f.onreadystatechange=function(){4==f.readyState&&(400==f.status||0==f.status?d(c,this.options):(200==f.status||302==f.status)&&e(f.responseText,a))},formData=L.Util.getParamString(this.options).split("?")[1],"XDomainRequest"in window){var g=new XDomainRequest;g.onerror=function(){g.abort(),d(c,this.options)},g.onload=function(){setToken(g.responseText)},g.open("POST",c,!0),g.send(formData)}else f.open("POST",c,!0),"string"==typeof formData&&f.setRequestHeader("Content-type","application/x-www-form-urlencoded"),f.send(formData)}});